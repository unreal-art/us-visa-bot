name: Visa Slot Monitor

on:
  schedule:
    # Run every 5 minutes
    - cron: "*/5 * * * *"
  workflow_dispatch:
    inputs:
      interval:
        description: "Monitor interval in seconds"
        required: false
        default: "30"
        type: string

jobs:
  monitor-slots:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install httpx python-dotenv rich

      - name: Set environment variables
        env:
          MONITOR_INTERVAL: ${{ github.event.inputs.interval || '30' }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "MONITOR_INTERVAL=$MONITOR_INTERVAL" >> $GITHUB_ENV
          echo "TELEGRAM_BOT_TOKEN=$TELEGRAM_BOT_TOKEN" >> $GITHUB_ENV
          echo "TELEGRAM_CHAT_ID=$TELEGRAM_CHAT_ID" >> $GITHUB_ENV

    - name: Run slot monitor
      run: |
        echo "üöÄ Starting visa slot monitoring..."
        echo "‚è∞ Interval: $MONITOR_INTERVAL seconds"
        echo "üì± Telegram: $([ -n "$TELEGRAM_BOT_TOKEN" ] && echo "Enabled" || echo "Disabled")"
        
        # Run the GitHub Actions compatible monitor
        python github_monitor.py
        
    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: monitor-logs-${{ github.run_number }}
        path: |
          *.log
          visa_automation.log
        retention-days: 7
